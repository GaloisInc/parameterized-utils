name: Build and test
on:
  - push
  - pull_request
jobs:
  test:
    name: Testing ${{ matrix.os }} GHC-${{ matrix.ghc }}
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.allow-failure }}
    strategy:
      matrix:
        os: [ubuntu-24.04]
        # See doc/dev.md for GHC version support policy
        ghc: [9.10.1, 9.8.1, 9.6.1, 9.4.5, 9.2.2, 9.0.2, 8.10.7, 8.8.4, 8.6.5]
        allow-failure: [false]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: haskell-actions/setup@v2
        id: setup-haskell
        with:
          ghc-version: ${{ matrix.ghc }}
      - uses: actions/cache/restore@v4
        name: Restore cabal store cache
        id: cache
        env:
          # NB: Each `matrix.os` (e.g., `ubuntu-22.04-arm`) uniquely determines
          # a `runner.arch` (e.g., ARM64), so there is no need to include the
          # latter as part of the cache key
          key: cabal-${{ matrix.os }}-ghc${{ matrix.ghc }}
        with:
          path: |
            ${{ steps.setup-haskell.outputs.cabal-store }}
            dist-newstyle
          key: |
            ${{ env.key }}-${{ github.ref }}
          restore-keys: |
            ${{ env.key }}-
      - name: Cabal update
        shell: bash
        run: cabal update
      - name: Cabal check
        shell: bash
        run: cabal check
      - name: Configure
        shell: bash
        # See doc/dev.md for development practices around warnings.
        run: cabal configure --disable-documentation --enable-tests --ghc-options='-Werror=compat -Werror=default'
      - name: Build
        shell: bash
        run: cabal build
      - name: Test
        shell: bash
        run: cabal test
      - name: Documentation
        shell: bash
        # Build the Haddocks to ensure that they are well formed. Somewhat
        # counterintuitively, we run this with the --disable-documentation flag.
        # This does not mean "do not build the Haddocks", but rather, "build the
        # Haddocks for the top-level library, but do not build dependencies with
        # Haddocks". The upshot is that we do not change the build configuration
        # for any dependencies, which means that we don't have to rebuild them.
        # The downside is that the rendered Haddocks won't contain any links
        # to identifiers from library dependencies. Since we are only building
        # Haddocks to ensure well-formedness, we consider this an acceptable
        # tradeoff.
        #
        # We build the full Haddocks in the "Documentation" workflow.
        run: cabal haddock --disable-documentation
      - uses: actions/cache/save@v4
        name: Save cabal store cache
        if: always()
        with:
          path: |
            ${{ steps.setup-haskell.outputs.cabal-store }}
            dist-newstyle
          key: ${{ steps.cache.outputs.cache-primary-key }}
      - name: Check Cabal/GHC compatibility
        uses: langston-barrett/.github/actions/cabal-ghc-compat@e002f215e05308cf337f919663986ed31ae78bf7
        with:
          ghc: ${{ matrix.ghc }}
          token: ${{ secrets.GITHUB_TOKEN }}
